# java使用客户端
https://www.tizi365.com/archives/938.html
https://www.tizi365.com/archives/947.html
https://www.tizi365.com/archives/949.html

## 构建查询请求
```java
SearchRequest searchRequest = new SearchRequest();
searchRequest.indices(index);
SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
sourceBuilder
        .size(0)
        .timeout(TimeValue.timeValueSeconds(60))
        .query(QueryBuilders.matchQuery("dt", "20210329"))
        .aggregation(AggregationBuilders.terms("name").field("xiaomiId").size(3000));
searchRequest.source(sourceBuilder);
SearchResponse response = helper.search(searchRequest);
```

## 结果集处理

### 1.value count 结果
```java
Aggregations aggregations = searchResponse.getAggregations();
// 根据orders命名查询，ValueCount统计结果
ValueCount valueCount = aggregations.get("orders");
// 打印结果
System.out.println(valueCount.getValue());
```

### 2.Cardinality
```java
Aggregations aggregations = searchResponse.getAggregations();
// 根据total命名查询，Cardinality统计结果
Cardinality cardinality = aggregations.get("total");
// 打印结果
System.out.println(cardinality.getValue());
```

### 3.avg

```java
Aggregations aggregations = searchResponse.getAggregations();
// 根据total命名查询，Avg统计结果
Avg avgPrice = aggregations.get("avg_price");
// 打印结果
System.out.println(avgPrice.getValue());
```

### 4.sum
```java
Aggregations aggregations = searchResponse.getAggregations();
// 根据total命名查询，Sum统计结果
Sum totalPrice = aggregations.get("total_sale");
// 打印结果
System.out.println(totalPrice.getValue());
```

### 5.max

```java
// 处理聚合查询结果
Aggregations aggregations = searchResponse.getAggregations();
// 根据max_price命名查询，Max统计结果
Max maxPrice = aggregations.get("max_price");
// 打印结果
System.out.println(maxPrice.getValue());
```

### 6.min

```java
Aggregations aggregations = searchResponse.getAggregations();
// 根据min_price命名查询，Min统计结果
Min minPrice = aggregations.get("min_price");
// 打印结果
System.out.println(minPrice.getValue());
```

### 7.Terms聚合
```java
Aggregations aggregations = searchResponse.getAggregations();
// 根据by_shop命名查询terms聚合结果
Terms byShopAggregation = aggregations.get("by_shop");

// 遍历terms聚合结果
for (Terms.Bucket bucket  : byShopAggregation.getBuckets()) {
    // 因为是根据shop_id分组，因此可以直接将桶的key转换成int类型
    int shopId = bucket.getKeyAsNumber().intValue();
    // 如果分组的字段是字符串类型，可以直接转成String类型
    // String key = bucket.getKeyAsString();
    // 获取文档总数
    long count = bucket.getDocCount();
}
```

### 8.Histogram聚合
```java
// 处理聚合查询结果
Aggregations aggregations = searchResponse.getAggregations();
// 根据prices命名查询Histogram聚合结果
Histogram histogram = aggregations.get("prices");
        
// 遍历聚合结果
for (Histogram.Bucket bucket  : histogram.getBuckets()) {
    // 获取桶的Key值
    String key = bucket.getKeyAsString();
    // 获取文档总数
    long count = bucket.getDocCount();
}
```

### 9.Date histogram聚合
```java
// 处理聚合查询结果
Aggregations aggregations = searchResponse.getAggregations();
// 根据sales_over_time命名查询Histogram聚合结果
Histogram histogram = aggregations.get("sales_over_time");
        
// 遍历聚合结果
for (Histogram.Bucket bucket  : histogram.getBuckets()) {
    // 获取桶的Key值
    String key = bucket.getKeyAsString();
    // 获取文档总数
    long count = bucket.getDocCount();
}
```

### 10.Range聚合
```java
// 处理聚合查询结果
Aggregations aggregations = searchResponse.getAggregations();
Range range = aggregations.get("price_ranges");

// 遍历聚合结果
for (Range.Bucket bucket  : range.getBuckets()) {
    // 获取桶的Key值
    String key = bucket.getKeyAsString();
    // 获取文档总数
    long count = bucket.getDocCount();
}
```

### 11.嵌套聚合的用法
```java
// 处理聚合查询结果
Aggregations aggregations = searchResponse.getAggregations();
Terms terms = aggregations.get("by_shop");

// 遍历聚合结果
for (Terms.Bucket bucket  : terms.getBuckets()) {
      // 获取桶的Key值
      String key = bucket.getKeyAsString();
      // 获取文档总数
      long count = bucket.getDocCount();

      // 处理嵌套聚合结果
      Aggregations subAggregations = bucket.getAggregations();
      // 根据avg_price命名，查询avg聚合结果
      Avg avgPriceResult = subAggregations.get("avg_price");
      // 获取平均价格
      double avgPrice = avgPriceResult.getValue();

      // 根据sum_price命名，查询sum聚合结果
      Sum sumPriceResult = subAggregations.get("sum_price");
      // 获取总价格
      double sumPrice = sumPriceResult.getValue();
}
```

## scorll查询
```java
SearchRequest request = new SearchRequest();
request.indices(rawLogIndex).scroll("10m");
SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
sourceBuilder
        .size(1)
        .query(QueryBuilders.matchQuery("dt", dt));
request.source(sourceBuilder);
SearchResponse response = searchHelper.search(request);

String scrollId = response.getScrollId();
// 持续从rawlog拿结果，直到数据为空
int count = 0;
while (true) {
    SearchScrollRequest scrollRequest = new SearchScrollRequest(scrollId);
    scrollRequest.scroll(TimeValue.timeValueSeconds(30));
    SearchResponse searchResponse = searchHelper.getRestClient().scroll(scrollRequest, RequestOptions.DEFAULT);
    SearchHit[] hits = searchResponse.getHits().getHits();
    if (hits.length == 0) {
        break;
    }
    count ++;
    String result = hits[0].getSourceAsString();
    System.out.println(result);
}
System.out.println(count)
```