# 数据库面试
![fail](https://cdn.jsdelivr.net/gh/pitifulnoble/picture@master/acf18f0bd9d2847aef1939bec04b31e3.png)
- 如何设计一个数据库
- 为什么要使用索引
- 什么样的数据适合做索引
- 索引的数据结构
- 如何调优 sql
- 联合索引最左匹配 原则
- 索引是建立的越多越好吗
## 如何设计一个数据库
![fail](https://cdn.jsdelivr.net/gh/pitifulnoble/picture@master/acacf2622cf039991f98671a1a3a3b45.png)

- 考察复杂问题分模块能力和数据库架构了解

首先分成2大模块，数据存储模块和程序实例模块。存储模块用于存储数据，程序实例模块让我们能很好的使用数据。
程序实例中要有存储管理，让我们能操作存储模块的数据。
缓存机制，磁盘读写IO很慢，数据操作一定是在内存中。通过缓存机制减少IO操作
SQL解析模块
日志管理-数据库需要有能恢复的binlog日志
权限划分-
容灾机制-数据库发生异常时如和处理，恢复到什么程度
索引和锁

## 数据结构

### 1.二分搜索树&红黑树
此类树太深，深度没增加1就要增加一次IO。根本无法提高查询效率

### 2.B树
https://www.cnblogs.com/nullzx/p/8729425.html

## 2.索引
- 为什么要使用索引
### 2.2.什么样的数据能成为索引
越能更好区分数据行的数据时候做索引，特征：
- 不重复度高
- 业务逻辑经常使用该字段过滤查询

### 2.3.索引的数据结构
B+ Tree更适合做索引存储
- B+树的磁盘读写代价更低
- B+树的查询效率更加稳定
- B+树更有利于对数据库的扫描(B+树叶子节点连在一起，范围查询更加高效)

### 2.4.密集索引和稀疏索引
Innodb是密集索引，普通索引的叶子节点存储主见，查询具体数据会发生回表。

### 2.5.最左匹配原则
和联合索引相关
- mysql会一直向右匹配直到遇到范围查询(> < between like)就停止匹配，比如 ``a=3 and b=4 and c>5 and d=6``,如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整。
- =和in可以乱序，比如``a=1 and b=2 and c=3``建立(a,b,c)索引可以任意顺序，mysql的查询优化器会帮助完成索引的识别

最左匹配原则的成因，使用联合索引中第一个索引建立B+树，其他索引的值保存在该B+树的叶子节点上。所以，必须使用第一个索引字段才能走该B+树。


- 覆盖索引&索引下堆

### 2.6索引是建立的越多越好吗
- 数据量小的表不需要建立索引，建立会增加额外的索引开销
- 数据变更需要维护索引，因此更多的索引意味着更多的维护成本
- 更多的索引意味着也需要更多的空间

## 3.锁
### 3.1.MyISAM与InnoDB关于锁方面的区别是什么
- 数据库事务的四大特性
- 事务隔离级别以及各级别下的并发访问问题
- InnoDB可重复读级别下如何避免幻读
- RC、RR级别下InnoDB的非阻塞读如何实现

### MyISAM与InnoDB关于锁方面的区别是什么
- MyISAM支持表级锁，不支持行级锁
- InnoDB支持行级锁和表级锁

### 数据库事务的四大特性
ACID
- 原子性(Atomic)
- 一致性(Consistency)
- 隔离性(Isolation)
- 持久性(Durabilty)

### 事务隔离级别以及各级别下的并发访问问题

### InnoDB可重复读级别下如何避免幻读
- 表象：快照读(非阻塞读)---伪MVCC
- 内在：next-key锁(行锁+gap锁)
    - 如果where条件全部命中，则不会用Gap锁，只会加记录锁
    - 如果where条件部分名字或全不命中，会加Gap锁。

#### Gap锁
Gap锁会用在非唯一索引或不走索引的当前读中
- 如果where条件全部命中，则不会用Gap锁，只会加记录锁
- 如果where条件部分名字或全不命中，会加Gap锁。

**非唯一索引**
![fail](https://cdn.jsdelivr.net/gh/pitifulnoble/picture@master/937115dfdac67e72483cfa95cef54f67.png)

**不走索引**
![fail](https://cdn.jsdelivr.net/gh/pitifulnoble/picture@master/d25546b4d6e0841c82ba9f73f53a15ff.png)
### RC、RR级别下InnoDB的非阻塞读如何实现
- 每行数据会记录DB_TRX_ID, DB_ROLL_PTR, DB_ROW_ID字段
- undo日志
- read view

![fail](https://cdn.jsdelivr.net/gh/pitifulnoble/picture@master/9e8efa0fa992afa2dee5519f297eaf64.png)
