# protoc基本使用
protoc和json一样是一种非绑定语言环境的数据交换格式，相对应json来说是二进制。

使用场景以go语言为例

## 1.安装工具
在mac安装go语言使用的环境

### 1.1.安装protoc本体工具
https://github.com/protocolbuffers/protobuf
下载解压：protoc-3.19.1-osx-x86_64.zip
并配置环境变量
官方protoc不支持go语言，我们需要安装插件：
```
go install github.com/golang/protobuf/protoc-gen-go@latest
```

### 1.2.安装protoc的go语言支持工具
https://github.com/grpc-ecosystem/grpc-gateway
安装方式参考readme


## 2.基本使用

### 2.1.新建文件trip.protoc
```protoc
syntax = "proto3";
package coolcar;
option go_package = "coolcar/proto/gen/go;trippb";

message Location {
  double latitude = 1;
  double longitude = 2;
}
message Trip {
  string start = 1;
  Location start_pos = 2;
  repeated Location path_locations = 7;
  string end = 3;
  Location end_pos = 4;
  int64 duration_sec = 5;
  int64 fee_cent = 6;
}
```

### 2.2.创建go语言struct实例
在trip.protoc文件当前目录下运行：
```
protoc -I=. --go_out=paths=source_relative:gen/go trip.proto
```

生成的go实例如下：
```go
type Location struct {
	state         protoimpl.MessageState
	sizeCache     protoimpl.SizeCache
	unknownFields protoimpl.UnknownFields

	Latitude  float64 `protobuf:"fixed64,1,opt,name=latitude,proto3" json:"latitude,omitempty"`
	Longitude float64 `protobuf:"fixed64,2,opt,name=longitude,proto3" json:"longitude,omitempty"`
}
type Trip struct {
	state         protoimpl.MessageState
	sizeCache     protoimpl.SizeCache
	unknownFields protoimpl.UnknownFields

	Start         string      `protobuf:"bytes,1,opt,name=start,proto3" json:"start,omitempty"`
	StartPos      *Location   `protobuf:"bytes,2,opt,name=start_pos,json=startPos,proto3" json:"start_pos,omitempty"`
	PathLocations []*Location `protobuf:"bytes,7,rep,name=path_locations,json=pathLocations,proto3" json:"path_locations,omitempty"`
	End           string      `protobuf:"bytes,3,opt,name=end,proto3" json:"end,omitempty"`
	EndPos        *Location   `protobuf:"bytes,4,opt,name=end_pos,json=endPos,proto3" json:"end_pos,omitempty"`
	DurationSec   int64       `protobuf:"varint,5,opt,name=duration_sec,json=durationSec,proto3" json:"duration_sec,omitempty"`
	FeeCent       int64       `protobuf:"varint,6,opt,name=fee_cent,json=feeCent,proto3" json:"fee_cent,omitempty"`
}
```

### 2.3.生成代码使用
```go
func TestName(t *testing.T) {
	trip := trippb.Trip{
		Start:       "hello",
		End:         "world",
		DurationSec: 3600,
		FeeCent:     1000,
	}
	fmt.Println(&trip)
	marshal, _ := proto.Marshal(&trip)
	fmt.Printf("%x\n", marshal)
	var trip2 trippb.Trip
	proto.Unmarshal(marshal, &trip2)
	fmt.Println(&trip2)
	bytes, _ := json.Marshal(&trip2)
	fmt.Printf("%s\n", bytes)
}
```

```
=== RUN   TestName
start:"hello"  end:"world"  duration_sec:3600  fee_cent:1000
0a0568656c6c6f1a05776f726c6428901c30e807
start:"hello"  end:"world"  duration_sec:3600  fee_cent:1000
{"start":"hello","end":"world","duration_sec":3600,"fee_cent":1000}
--- PASS: TestName (0.00s)
PASS
```

### 2.4.零值处理
protoc v3中 未被定义的字段是零值，要小心考虑零值的意义，可能会导致生产环境bug。
